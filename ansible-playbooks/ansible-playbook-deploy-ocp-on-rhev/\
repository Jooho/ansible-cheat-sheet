---

- name: check if it is already registered with same subscription
  command: "subscription-manager list --consumed"
  register: comsumed_subs

- debug: var=pool_id
- name: Register node to rhsm and attach pool using name
  redhat_subscription:
    username: "{{ subs.id }}"
    password: "{{ subs.pw }}"
    pool: "^{{ pool_name }}$"
    state: present
  when: pool_name|bool and not comsumed_subs.stdout|search(pool_name)
  register: task_result
  until: task_result|success
  retries: 10
  delay: 1
  ignore_errors: yes

- debug: var=task_result
- name: Register node to rhsm and attach pool using id
  redhat_subscription:
    username: "{{ subs.id }}"
    password: "{{ subs.pw }}"
    pool_ids: "{{ pool_id }}"
    state: present
  when: pool_id|bool and not comsumed_subs.stdout|search(pool_id)
  register: task_result
  until: task_result|success
  retries: 10
  delay: 1
  ignore_errors: yes
- debug: var=task_result


- name: Register node to rhsm and attach pool using consumerid
  redhat_subscription:
    username: "{{ subs.id }}"
    password: "{{ subs.pw }}"
    consumer_id: "{{ consumerid }}"
    state: present
  when: consumerid|bool 
  register: task_result
  until: task_result|success
  retries: 10
  delay: 1
  ignore_errors: yes
